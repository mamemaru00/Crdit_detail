# 機能要件詳細 03 - Googleスプレッドシート連携・更新機能

## 5. Googleスプレッドシート連携機能【優先度:高】

### 機能概要
Google Sheets APIを使用して、対象のスプレッドシートに接続する。

### 詳細仕様
**認証方式**
- Googleサービスアカウント認証を使用
- サービスアカウント：creditapi@creditapi-470614.iam.gserviceaccount.com
- プロジェクトID：creditapi-470614
- 認証情報ファイル（JSON）をDocker環境内に配置

**認証の特徴**
- ブラウザ認証不要で完全自動化
- OAuth認証フローが不要
- Docker環境に最適
- ユーザー操作なしで実行可能

**認証フロー**
1. サービスアカウント認証情報（JSON）を読み込み
2. Google Sheets APIに接続
3. スプレッドシートIDを指定してアクセス
4. 年シートを特定
5. データの読み書き実行

**スプレッドシート設定**
- スプレッドシートIDの指定
- 年シート名の指定（例：2025年）
- 対象スプレッドシートにサービスアカウントを編集者として共有

**エラーハンドリング**
- API接続エラーの検出と通知
- 権限エラーの詳細メッセージ表示
- ネットワークエラーのリトライ処理
- レート制限超過時の待機処理

**年シート自動検出**
- 利用月から対象年を判定
- 該当する年シートの存在確認
- 存在しない場合のエラー通知

### 入出力
**入力**: サービスアカウント認証情報（JSON）、スプレッドシートID、シート名
**出力**: スプレッドシート接続状態、シート情報

## 6. 年別シート更新機能【優先度:高】

### 機能概要
解析したCSVデータを、年別シートの該当する月行・カテゴリ列に加算する。

### 詳細仕様
**シート構造の理解**
- 行1：タイトル行
- 行2：空行
- 行3：ヘッダー行
- 行4-15：月別データ（1月～12月）
- 行16：年計（合計行）

**更新ロジック**
1. 年シートの特定（利用月から年を判定）
2. 月行の特定（例：8月 → 行11）
3. カテゴリ列への金額加算
4. 既存値を取得し、新規金額を加算

**月行の計算式**
```
行番号 = 3 + 月番号
例：8月の場合 → 3 + 8 = 11行目
```

**集計処理**
- 月別・カテゴリ別の合計算出
- 各明細の振り分け先を記録
- 処理件数のカウント

**トランザクション処理**
- 全ての更新が成功するまでコミットしない
- エラー時は全てロールバック
- データ整合性を保証

**処理結果の出力**
- 月別・カテゴリ別の加算額サマリー
- 処理詳細ログ（各明細の振り分け先）
- 未登録店舗リスト
- 処理件数と合計金額

**出力例**
```
2025年8月:
 ├ 外食費(C列): +11,560円 (8件)
 ├ 日用品費(D列): +7,045円 (5件)
 ├ 娯楽費(G列): +3,100円 (3件)
 └ 交通費(N列): +5,870円 (1件)

合計: 17件 / 27,575円

⚠ 未登録店舗: 2件
```

### 入出力
**入力**: 構造化された明細データ（カテゴリ情報付き）、対象スプレッドシート情報
**出力**: 更新完了メッセージ、月別・カテゴリ別サマリー、処理詳細ログ、未登録店舗リスト

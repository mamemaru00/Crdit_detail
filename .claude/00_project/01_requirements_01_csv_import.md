# 機能要件詳細 01 - CSVファイル取込・解析機能

## 1. CSVファイル取込機能【優先度:高】

### 機能概要
イオンカードから出力された利用明細CSVファイルを選択・アップロードし、システムに取り込む。

### 詳細仕様
**ファイル選択**
- ユーザーがローカルPCからCSVファイルを選択
- 対応形式：イオンカード専用フォーマット（Shift_JIS）
- ファイルサイズ上限：10MB

**エンコーディング処理**
- Shift_JISエンコーディングを自動検出
- UTF-8への自動変換処理
- chardetライブラリを使用した文字コード判定

**ファイル検証**
- ヘッダー行の存在確認
- 必須カラム（利用日、利用先、金額）の検証
- データ形式の妥当性チェック

**プレビュー機能**
- 取込前に最初の5件を画面表示
- 利用日、店舗名、金額を一覧表示
- ユーザーによる目視確認を可能にする

**エラーハンドリング**
- ファイル形式エラー時の詳細メッセージ表示
- エンコーディングエラーの検出と通知
- 不正なデータ行の特定とスキップ

**処理後の動作**
- CSVファイルは処理完了後、サーバー上から自動削除
- セキュリティリスクを最小化

### 入出力
**入力**: イオンカード利用明細CSVファイル（Shift_JIS）
**出力**: CSV解析結果、エラーメッセージ、プレビューデータ

## 2. CSV解析機能【優先度:高】

### 機能概要
アップロードされたCSVファイルを解析し、必要な項目を抽出・変換する。

### 詳細仕様
**データ構造の識別**
- ヘッダー部と明細部を自動識別
- 明細データは6桁数字で始まる行として判定
- 8行目以降を明細データとして処理

**日付変換処理**
- YYMMDD形式（例：250815）をYYYY/MM/DD形式（例：2025/08/15）に変換
- Date型への変換と妥当性検証
- 利用月の抽出（例：2025年8月）

**カラム抽出**
- 列0：利用日（YYMMDD形式）
- 列2：利用先（店舗名）
- 列6：利用金額
- 列7：備考

**データ変換**
- 金額データを数値型に変換（カンマ除去）
- 店舗名の正規化（全角・半角統一）
- 月番号の付与（1-12）

**月別グループ化**
- 利用月ごとにデータを集計
- 各明細にカテゴリ情報を付与
- 月別・カテゴリ別の小計を算出

### 入出力
**入力**: CSVファイルデータ
**出力**: 構造化された明細データ（月情報・カテゴリ情報付き）、月別データグループ

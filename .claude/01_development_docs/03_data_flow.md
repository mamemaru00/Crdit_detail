# データフロー

## 6.4 アプリケーションデータフロー

### 6.4.1 CSV取込から反映までの流れ

```
1. CSVアップロード
   ↓
2. ファイル検証（形式・エンコーディング確認）
   ↓
3. データ解析（利用日・店舗名・金額抽出）
   ↓
4. プレビュー表示（5件表示）
   ↓
5. 実行ボタン押下
   ↓
6. マッピング照合
   ├─ 登録済み店舗 → カテゴリ・列番号特定
   └─ 未登録店舗 → 一時保存
   ↓
7. 月別・カテゴリ別集計
   ↓
8. スプレッドシート書き込み
   ├─ 対象年シート選択
   ├─ 該当月の行特定
   └─ カテゴリ列に金額加算
   ↓
9. 結果表示
   ├─ 処理サマリー
   ├─ 未登録店舗リスト
   └─ 詳細ログ生成
```

### 6.4.2 データ構造

#### CSV入力データ
```
利用日, 店舗名, 金額
2024/01/15, セブンイレブン新宿店, 1500
2024/02/20, スターバックス渋谷店, 800
```

#### マッピングデータ（JSON保存）
```json
{
  "店舗名パターン": "セブンイレブン",
  "一致方法": "前方一致",
  "カテゴリ": "日用品",
  "列番号": "B"
}
```

#### 集計データ
```python
{
  "2024-01": {
    "日用品": {"金額": 15000, "件数": 10},
    "食費": {"金額": 8000, "件数": 5}
  }
}
```

### 6.4.3 スプレッドシート書き込みロジック

1. **年シート選択**: 対象年（例：2024年）のシートを取得
2. **月行特定**: 1月=2行目、2月=3行目...12月=13行目
3. **カテゴリ列特定**: マッピングで指定された列（B～V列）
4. **金額加算**: 既存値に新規金額を加算（初期値0）
5. **一括更新**: batchUpdate APIで効率的に書き込み

### 6.4.4 エラーハンドリング

- CSV読込失敗 → エラーメッセージ表示
- マッピング未設定 → デフォルト列（B列）に振り分け
- API書き込み失敗 → リトライ3回、失敗時ログ保存
- 未登録店舗 → 一時リストに保存、ユーザー確認画面表示